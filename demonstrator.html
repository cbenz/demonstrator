<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/favicon.ico">

    <title>Demonstateur de l'API Web OpenFisca</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      //Variables globales
      var salaire1 = 25000
      var salaire2 = 15000
      var revenuDisponible = 0

      window.addEventListener('load', appelALAPI, false);

      // Fonctions
      function miseAjourDesSalaires(salaire, montant){
        if (salaire == "salaire1"){
          salaire1 = Number(montant);
        }else if (salaire == "salaire2"){
          salaire2 = Number(montant);
        };
        appelALAPI()
      }
      function JSONDeLaSituation(){
        var scenarioObj = {
                    scenarios: [
                      {
                        test_case: {
                          familles: [
                            {
                              parents: ["individu0", "individu1"]
                            }
                          ],
                          foyers_fiscaux: [
                            {
                              declarants: ["individu0", "individu1"],
                            }
                          ],
                          individus: [
                            {
                              date_naissance: "1980-01-01",
                              id: "individu0",
                              salaire_de_base: salaire1
                            },
                            {
                              date_naissance: "1982-01-01",
                              id: "individu1",
                              salaire_de_base: salaire2
                            }
                          ],
                          menages: [
                            {
                              personne_de_reference: "individu0",
                              conjoint:"individu1"
                            }
                          ]
                        },
                        period: "2016"
                      }
                    ],
                    variables: ["revenu_disponible"],
                    intermediate_variables: true
          }
        var scenarioString = JSON.stringify(scenarioObj)
        return scenarioString
        }
      function appelALAPI(){
        var xmlhttp = new XMLHttpRequest();
        var url = "https://api.openfisca.fr/api/1/calculate";
        var json = JSONDeLaSituation();
        xmlhttp.open("POST", url, true);

        xmlhttp.onreadystatechange=function() {
          //console.log(xmlhttp.responseText)
          if (xmlhttp.readyState==4 && xmlhttp.status==200) {
            responseFromAPI = JSON.parse(xmlhttp.responseText);
            //console.log(responseFromAPI || xmlhttp.responseText);
            transformationDeLaDonnee(responseFromAPI);
            }
          };
        xmlhttp.setRequestHeader("Content-Type", "application/json");
        xmlhttp.send(json);
        }
      function transformationDeLaDonnee(responseFromAPI) {
        var resultats = {};
        results["revenu_disponible"] = Math.round(responseFromAPI.value[0].menages[0].revenu_disponible["2016"]);
        results["impots_directs"] = -Math.round((responseFromAPI.value[0].menages[0].impots_directs["2016"]));
        results["revenus_du_travail"] = 0;
        for (var individu in responseFromAPI.value[0].individus){
          results["revenus_du_travail"] += Math.round(responseFromAPI.value[0].individus[individu].revenus_du_travail["2016"]);
            }
        results["prestations_sociales"] = Math.round(responseFromAPI.value[0].familles[0].prestations_sociales["2016"]);
        results["txDImposition"] = Math.round((results["impots_directs"])*100/(results["impots_directs"] + (results["revenu_disponible"])));
        results["txDisponible"] = Math.round(100 - results["txDImposition"]);
        results["salairesBruts"] = salaire1 + salaire2;
        results["chargesSalariales"] = results["salairesBruts"] - results["revenus_du_travail"];
        affichageDeLInformation(results);
        };
      function affichageDeLInformation(results){
        console.log(results);
        document.getElementById("txtRevenuDisponible").innerHTML=`
          <li>dispose d'un <strong>revenu disponible</strong> de ` + (Math.round(results["revenu_disponible"])).toLocaleString("fr") + ` €/an, c'est à dire ` + (Math.round(results["revenu_disponible"]/12)).toLocaleString("fr") + ` €/mois ;</li>
          <li> est <strong>imposé directement</strong> à hauteur de `+ results["txDImposition"]+`%( `+results["impots_directs"].toLocaleString("fr") + ` €/an, c'est à dire `+ Math.round(results["impots_directs"]/12).toLocaleString("fr") + ` €/mois) ;</li>
          <li>perçoit `+results["prestations_sociales"].toLocaleString("fr")+ ` €/an de <strong>prestations sociales</strong>, c'est à dire `+ Math.round(results["prestations_sociales"]/12).toLocaleString("fr") + ` €/mois.</li>`;
          //Display du graph
          google.charts.load('current', {'packages':['treemap']});
          google.charts.setOnLoadCallback(drawChart);
          function drawChart() {
            var data = google.visualization.arrayToDataTable([
              ['Element', 'Source', 'Montant', 'Montant (color)'],
              ['Salaires bruts',null, results["salairesBruts"], results["salairesBruts"]],
              ['Charges salariales', 'Salaires bruts', results["chargesSalariales"], - results["chargesSalariales"]],
              
              ['Impots directs', 'Salaires bruts', results["impots_directs"] , - results["impots_directs"] ],
              ['Revenu disponible', 'Salaires bruts', results["revenu_disponible"],                               results["revenu_disponible"]],
              ['Revenu du travail', 'Revenu disponible', results["revenus_du_travail"],                               results["revenus_du_travail"]],
              ['Prestations sociales', 'Revenu disponible', results["prestations_sociales"], results["prestations_sociales"]],
            ]);

            tree = new google.visualization.TreeMap(document.getElementById('chart_div'));

            tree.draw(data, {
              minColor: '#5bc0de',
              midColor: '#5bc0de',
              maxColor: '#5cb85c',
              headerHeight: 55,
              fontColor: 'black',
              showScale: true
            });

          }
          document.getElementById("graph").innerHTML='<div id="chart_div" style="width: 100%; height: 100%;"></div>';

        } 
    </script>
  </head>

  <body style="padding-top: 65px;">
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://openfisca.fr/">OpenFisca</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="https://doc.openfisca.fr/">Documentation</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="/contact">Contact</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Français<span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li role="presentation" class="dropdown-header">France</li>
                  <li><a href="/">Français</a></li>
                  <li><a href="/en">English</a></li>
                </ul>
              </li>
            </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    </nav>

    <!-- simulateur -->
    <div class="container">
      <div class="page-header">
          <h1>Calcul du revenu disponible</h1>
          <p class="lead">Le revenu disponible représente l'ensembles des revenus issus du travail, des pensions, des revenus du capital et des prestations sociales, auxquelles on soustrait les impots directs du ménage.</p>
        </div>
      <div class="row">
        <!-- entrée des données -->
        <div class="col-md-4">
          <form action="javascript:void(0);">
            <p><b>Salaire annuel brut du premier conjoint :</b></p>
            <p>
              <input type="text" onkeyup= miseAjourDesSalaires("salaire1",this.value) size="20" value="25000"> €/an
            </p>
            <p><b>Salaire annuel brut du second conjoint :</b></p>
            <p>
            <input type="text" onkeyup=miseAjourDesSalaires("salaire2",this.value) size="20" value="15000"> €/an
            </p>
            <p>
            </p>
          </form>
          </div>
        <div class="col-md-8">
          <p>Ce ménage, composé de 2 adultes sans enfants, et qui ne perçoit ni pensions ni revenus du capital :</p>
          <span id="txtRevenuDisponible"></span>
        </div>
      </div>
      <hr>
      <div class="row">
        <!-- entrée des données -->
        <div class="col-md-4">
        <h3>Visualisation</h3>
          <ul>
          <li>Cliquez sur "Revenu disponible" pour en voir le détail.</li>
          <li>Faites un clic-droit pour revenir à la distribution précédente.</li>
          </ul>
          </div>
       <!-- Visualisation -->
        <div class="col-md-8">
          <!-- partie sur les revenus disponibles -->
          <span id="graph"></span>
          </div>
        </div>
      </div>
      <hr>
      </div>


      <footer>
        <p>OpenFisca-France@XXXXXXXX (insérer la version)</p>
      </footer>
    </div> <!-- /container -->
  </body>
</html>
